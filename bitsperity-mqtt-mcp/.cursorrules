# bitsperity-mqtt-mcp - Projektspezifische Cursor Rules

## Projekt Kontext
- **App Name**: bitsperity-mqtt-mcp
- **Purpose**: MQTT Model Context Protocol Server fÃ¼r AI-gestÃ¼tzte IoT Device Analysis
- **Status**: Phase 3 Complete âœ… - Ready for Phase 4 ğŸš€
- **Current Phase**: Phase 4 - Advanced Tools & Production (Ready to Start)
- **Target Platform**: Umbrel App Store

## ğŸ‰ Phase 3 Implementation Complete âœ…

### Status Update
- **Phase 3 Completed**: 2025-01-23 (1 day - ahead of 3-day schedule)
- **All Quality Gates**: âœ… Met
- **All Tests**: âœ… 36/36 passing (100%)
- **Memory Usage**: âœ… ~45MB (target <128MB)
- **Simple Data Optimization**: âœ… Complete and tested

### Implementation Achieved
- âœ… **Smart Message Pruning**: 500â†’50 intelligent reduction working
- âœ… **7 Total Tools**: All Phase 1+2+3 tools functional
- âœ… **Schema Analysis**: get_topic_schema with pattern detection
- âœ… **Performance Optimization**: Memory and speed improvements
- âœ… **Python 3.10 Compatibility**: Fixed asyncio.timeout issues
- âœ… **Backward Compatibility**: All existing functionality preserved

## ğŸš€ Ready for Phase 4: Advanced Tools & Production

### Phase 4 Goals
- **Duration**: 7 Tage
- **Goal**: Advanced tools and production-ready deployment
- **Focus**: Complete the 10-tool MVP with production optimization

### Phase 4 Immediate Tasks
1. **Advanced Tools**: Implement debug_device, monitor_performance, test_connection
2. **Production Optimization**: Docker multi-stage builds, memory optimization
3. **Umbrel Integration**: Complete deployment configuration
4. **Web Monitoring**: FastAPI interface for real-time monitoring
5. **Advanced Error Recovery**: Enhanced error handling strategies
6. **Documentation Enhancement**: Complete API documentation

## âš ï¸ WICHTIG: Mermaid Diagramme fÃ¼r alle *.md Dateien

**ALLE System Architecture und Design Diagramme MÃœSSEN Mermaid syntax verwenden:**

### Phase 2 MQTT Integration Flow mit Mermaid
```mermaid
sequenceDiagram
    participant AI as AI Assistant
    participant MCP as MCP Server
    participant MQTT as MQTT Broker
    participant IOT as IoT Device

    AI->>MCP: establish_connection(mqtt://broker:1883)
    MCP->>MQTT: Connect with aiomqtt
    MQTT->>MCP: Connection established
    MCP->>AI: Session ID returned

    AI->>MCP: list_topics(session_id)
    MCP->>MQTT: Subscribe to $SYS/# (discovery)
    MQTT->>MCP: Topic list
    MCP->>AI: Available topics returned

    AI->>MCP: subscribe_and_collect(session_id, "sensor/+/data", 30s)
    MCP->>MQTT: Subscribe to topic pattern
    IOT->>MQTT: Publish sensor data
    MQTT->>MCP: Forward messages
    MCP->>MCP: Collect for 30 seconds
    MCP->>AI: Message collection returned
```

### Phase 2 Tool Implementation mit Mermaid
```mermaid
graph TB
    subgraph "Phase 2 Implementation"
        A[Real MQTT Client] --> B[aiomqtt Integration]
        B --> C[Topic Discovery]
        B --> D[Message Collection]
        B --> E[Message Publishing]
        
        C --> F[list_topics Tool]
        D --> G[subscribe_and_collect Tool]
        E --> H[publish_message Tool]
        
        F --> I[Topic Pattern Matching]
        G --> J[Time-bounded Collection]
        H --> K[QoS Level Support]
    end
    
    subgraph "Phase 1 Foundation âœ…"
        L[Session Management]
        M[Tool Registry]
        N[JSON-RPC 2.0]
    end
    
    L --> A
    M --> F
    M --> G
    M --> H
    N --> A
```

## Development Plan Summary âœ…

### 4-Phase Development Timeline
- **Phase 1**: MCP Foundation (Week 1) - âœ… Complete (1 day)
- **Phase 2**: MQTT Core Tools (Week 2) - ğŸš€ Ready to Start
- **Phase 3**: AI Optimization (Week 3) - â¸ï¸ Blocked by Phase 2
- **Phase 4**: Production Ready (Week 4) - â¸ï¸ Blocked by Phase 3

### Current Phase Status (Phase 2 Ready)
- **Goal**: Real MQTT broker integration mit core tools
- **Duration**: 7 Tage
- **Total Tools**: 6 tools (3 Phase 1 âœ… + 3 Phase 2)
- **Success Criteria**: Real MQTT communication, topic discovery, message collection/publishing

### Phase 2 Dependencies âœ… Ready
- **SimpleMCPServer**: âœ… Tool registration working
- **Session Management**: âœ… Encryption and TTL working
- **Background Tasks**: âœ… Async infrastructure established
- **Testing Framework**: âœ… pytest-asyncio ready fÃ¼r real MQTT testing

## Requirements Summary
- **Total User Stories**: 35 (US-001 bis US-035)
- **MVP Features**: 6 Features (F-001, F-002, F-003, F-004, F-009, F-010)
- **Key Epics**: Connection Management âœ…, Topic Discovery ğŸš€, Message Monitoring ğŸš€, Device Debugging â¸ï¸, Integration Testing ğŸš€, Performance Monitoring â¸ï¸
- **Primary User**: IoT Developer / System Integrator
- **Secondary User**: AI Assistant (Cursor/Claude)

## Technical Architecture âœ… + Phase 2 Ready

### Technology Stack
- **Language**: Python 3.11+ mit asyncio âœ…
- **MQTT Library**: aiomqtt (async/await native) ğŸš€ Ready to implement
- **MCP Protocol**: JSON-RPC 2.0 over STDIO âœ…
- **Web Interface**: FastAPI fÃ¼r Monitoring (Port 8090) â¸ï¸ Phase 3
- **Security**: cryptography (Fernet) fÃ¼r Session-Encryption âœ…
- **Deployment**: Docker multi-stage builds + Umbrel integration âœ…

### Core Components (Implementation Status)
1. **SimpleMCPServer** - JSON-RPC 2.0 protocol handler âœ… Complete
2. **MQTTConnectionManager** - Session lifecycle + security âœ… Complete
3. **MQTTTools** - Phase 1: 3 tools âœ…, Phase 2: +3 tools ğŸš€
4. **MessageCollector** - Real-time message collection (Phase 2) ğŸš€
5. **MessagePruner** - AI-optimized intelligent pruning (Phase 3) â¸ï¸
6. **SchemaAnalyzer** - Message structure analysis (Phase 3) â¸ï¸
7. **WebMonitor** - FastAPI monitoring interface (Phase 3) â¸ï¸

### Architecture Decisions (ADRs)
- **ADR-001**: aiomqtt fÃ¼r full async support âœ… Ready fÃ¼r Phase 2
- **ADR-002**: In-memory session store mit encryption âœ… Implemented
- **ADR-003**: Time-bounded collection mit pruning ğŸš€ Phase 2 target
- **ADR-004**: FastAPI fÃ¼r monitoring â¸ï¸ Phase 3
- **ADR-005**: Hierarchical error classes mit recovery strategies âœ… Foundation ready

## Phase Implementation Strategy

### Phase 1: MCP Foundation âœ… COMPLETE
**Deliverables Complete**:
- âœ… SimpleMCPServer mit JSON-RPC 2.0 support
- âœ… MQTTConnectionManager mit Fernet encryption
- âœ… Basic tool implementations (3 tools)
- âœ… SSH + docker exec integration patterns
- âœ… Unit test framework (13/13 tests passing)

**Quality Gates All Met**:
- âœ… SSH integration patterns established
- âœ… Session management with encryption works
- âœ… Basic MCP tools respond correctly
- âœ… Memory usage <128MB (actual: ~50MB)

### Phase 2: MQTT Core Tools ğŸš€ READY TO START
**Deliverables Target**:
- ğŸš€ aiomqtt integration (replace mock connections)
- ğŸš€ Topic discovery (list_topics tool)
- ğŸš€ Message collection (subscribe_and_collect tool)
- ğŸš€ Message publishing (publish_message tool)
- ğŸš€ Real MQTT broker integration testing

**Quality Gates Target**:
- [ ] MQTT broker connection reliable
- [ ] Topic discovery finds actual topics
- [ ] Message collection time-bounded works
- [ ] QoS levels function correctly

### Phase 3: AI Optimization â¸ï¸ Blocked by Phase 2
**Deliverables Future**:
- Intelligent message pruning (500â†’50 messages)
- Schema analysis for message structures
- Web monitoring interface (FastAPI)
- Performance optimization

### Phase 4: Production Ready â¸ï¸ Blocked by Phase 3
**Deliverables Future**:
- Advanced tools (debug_device, monitor_performance, test_connection, get_topic_schema)
- Docker multi-stage builds optimization
- Umbrel deployment integration
- Complete testing suite

## Projekt Standards

### Documentation Location
- **AI Docs**: `ai_docs/` Ordner mit vollstÃ¤ndiger Dokumentation
- **Requirements**: `ai_docs/requirements/` (âœ… abgeschlossen)
- **System Design**: `ai_docs/system-design/` (âœ… abgeschlossen)
- **Development Plan**: `ai_docs/development-plan/` (âœ… abgeschlossen)
- **Implementation**: `ai_docs/implementation/` (âœ… Phase 1 complete, ğŸš€ Phase 2 ready)
  - âœ… phase-1-progress.md (Complete)
  - ğŸš€ phase-2-progress.md (Ready to create)

### Technical Context
- **Based On**: bitsperity-mongodb-mcp (gleiche MCP patterns und deployment) âœ…
- **Session Model**: UUID-based, 1h TTL, max 5 concurrent MQTT connections âœ…
- **Message Handling**: Time-bounded (10-300s), intelligent pruning (â†’50 messages) ğŸš€ Phase 2
- **Deployment**: SSH + docker exec integration wie MongoDB MCP âœ…

## Core Business Rules

### MQTT Specific Rules
- **Connection Format**: `mqtt://[username:password@]broker:port[/client_id]` âœ… Implemented
- **QoS Support**: 0 (fire-and-forget), 1 (at-least-once), 2 (exactly-once) ğŸš€ Phase 2
- **Topic Patterns**: MQTT wildcards (+ single level, # multi level) ğŸš€ Phase 2
- **Message Limits**: Max 500 messages/collection, 1MB payload, 1000 topics/discovery ğŸš€ Phase 2
- **Security**: No credential persistence âœ…, memory-only âœ…, session isolation âœ…

### AI Optimization Rules
- **Response Size**: Optimized fÃ¼r LLM Context Limits â¸ï¸ Phase 3
- **Message Pruning**: Preserve errors, first/last messages, temporal distribution, payload diversity â¸ï¸ Phase 3
- **Human Readable**: Include summaries und context fÃ¼r AI understanding âœ… Foundation ready
- **Structured Output**: Consistent data structures across all tools âœ… Implemented

## Development Context

### Target Integration
- **Umbrel Host**: SSH-based deployment model (host network for MCP server) âœ… Ready
- **Test MQTT Broker**: `mqtt://192.168.178.57:1883` (development) ğŸš€ Phase 2 target
- **Production MQTT**: `mosquitto_broker_1:1883` (container network) ğŸš€ Phase 2 target
- **Web Interface**: Port 8090 fÃ¼r Monitoring und Status â¸ï¸ Phase 3
- **AI Integration**: Cursor IDE via SSH + docker exec âœ… Patterns established

### Phase 2 Development Environment âœ… Ready
```bash
# Phase 1 setup complete and ready for Phase 2
docker build -t bitsperity-mqtt-mcp:dev --target development .
docker run --rm -it bitsperity-mqtt-mcp:dev pytest tests/ -v
# Result: 13 passed in 1.52s âœ…

# Phase 2 tasks ready to start:
# 1. Replace mock MQTT connections with aiomqtt
# 2. Implement real broker integration
# 3. Add topic discovery functionality
# 4. Add message collection and publishing
```

### Docker Architecture (Production Ready)
```yaml
services:
  mcp-server:
    image: bitsperity-mqtt-mcp:dev  # âœ… Built and working
    network_mode: host             # âœ… SSH access fÃ¼r AI Assistant
    stdin_open: true              # âœ… MCP STDIO communication
    tty: true                     # âœ… Ready for deployment
  web:
    ports: ["8090:8080"]          # â¸ï¸ Phase 3 - Web monitoring interface
```

## MVP Scope Definition

### Must-Have Tools Phase 1-2 - 6 Tools
1. **establish_connection** - MQTT broker connection mit auth âœ… Complete
2. **list_active_connections** - Session management âœ… Complete
3. **close_connection** - Session cleanup âœ… Complete
4. **list_topics** - Topic discovery mit wildcards ğŸš€ Phase 2 Next
5. **subscribe_and_collect** - Time-bounded message collection ğŸš€ Phase 2 Next
6. **publish_message** - Message publishing mit QoS support ğŸš€ Phase 2 Next

### Should-Have Tools (Phase 3-4) - 4 Tools
7. **get_topic_schema** - Message structure analysis â¸ï¸ Phase 4
8. **debug_device** - Device-specific monitoring â¸ï¸ Phase 4
9. **monitor_performance** - Throughput & latency metrics â¸ï¸ Phase 4
10. **test_connection** - Health check â¸ï¸ Phase 4

## Risk Management

### High Priority Risks 
- **RISK-001**: MQTT Integration Failure - ğŸš€ Phase 2 Focus
  - *Status*: Ready to tackle with aiomqtt
  - *Mitigation*: Comprehensive testing framework established
- **RISK-002**: SSH Integration Issues - âœ… RESOLVED
  - *Status*: Docker + STDIO patterns established successfully

### Medium Priority Risks
- **RISK-003**: Performance Targets - âœ… Phase 1 baseline established
- **RISK-004**: Message Pruning Quality - â¸ï¸ Phase 3 concern
- **RISK-005**: Docker Deployment - âœ… Foundation working

## Quality Gates

### Phase 1 Completeness âœ… ALL MET
- [x] Functional SimpleMCPServer with tool registration
- [x] Working session management with encryption
- [x] SSH + docker exec integration patterns established
- [x] Basic error handling framework
- [x] Unit test framework established
- [x] All 13 tests passing (100% success rate)
- [x] Memory usage under target (<50MB vs <128MB)

### Phase 2 Readiness Checklist âœ… ALL READY
- [x] Development environment proven working
- [x] Project structure established
- [x] SSH access patterns established
- [x] Git repository with complete Phase 1 foundation
- [x] Development tools configured and tested

## Integration Requirements

### MCP Protocol Compliance âœ… ACHIEVED
- **SSH Integration**: âœ… Docker + STDIO patterns established
- **JSON-RPC 2.0**: âœ… All tool calls follow MCP standard
- **Error Handling**: âœ… Standardized responses ohne credential exposure
- **Tool Schema**: âœ… JSON schema framework ready fÃ¼r all 10 tools

### Umbrel Integration âœ… READY
```yaml
# umbrel-app.yml pattern established
id: bitsperity-mqtt-mcp
category: developer-tools
port: 8090
dependencies: []  # No hard dependencies
```

## Current Development Status

### Completed Phases âœ…
- [x] **Requirements Analysis** - 35 user stories, 10 features, acceptance criteria
- [x] **System Architecture** - Component design, tech stack, deployment strategy
- [x] **Development Planning** - 4 phases, daily tasks, risk assessment
- [x] **Phase 1 Implementation** - MCP Foundation complete, all tests passing

### Current Phase: Phase 2 ğŸš€ READY TO START
- **Status**: All dependencies met, ready to implement
- **Next Action**: Start real MQTT integration mit aiomqtt
- **Duration**: 7 days (ahead of schedule opportunity)
- **Deliverables**: Real MQTT broker integration + 3 new tools

### Ready for Implementation
- âœ… Implementation Guide rules established
- âœ… Phase 2 daily tasks clearly defined
- âœ… All dependencies and risks identified and managed
- âœ… Quality gates established for validation
- âœ… Docker development environment proven
- âœ… Testing framework comprehensive and working

## Use Case Examples (Phase 2 Target)

### Typical AI Assistant Interactions (Phase 2)
```
"Verbinde dich mit mqtt://192.168.178.57:1883"          # âœ… Working
"Zeige mir alle verfÃ¼gbaren Topics"                     # ğŸš€ list_topics - Phase 2
"Sammle 60 Sekunden Messages von sensor/+/temperature"  # ğŸš€ subscribe_and_collect - Phase 2  
"Sende eine Test-Message an device/pump1/command"       # ğŸš€ publish_message - Phase 2
```

### Error Handling Examples âœ… Working
```
ConnectionError: "Failed to connect to broker 192.168.178.57:1883 - timeout after 30s" # âœ… Implemented
SessionExpiredError: "Session abc123 expired after 1 hour - please reconnect"           # âœ… Implemented
TopicValidationError: "Invalid topic pattern 'sensor//temp' - empty level not allowed"  # ğŸš€ Phase 2
```

## File Structure (Current) âœ…

```
bitsperity-mqtt-mcp/
â”œâ”€â”€ ai_docs/
â”‚   â”œâ”€â”€ requirements/           # âœ… Requirements Phase Complete
â”‚   â”œâ”€â”€ system-design/         # âœ… System Architecture Complete
â”‚   â”œâ”€â”€ development-plan/      # âœ… Development Planning Complete
â”‚   â””â”€â”€ implementation/        # âœ… Phase 1 Complete, ğŸš€ Phase 2 Ready
â”‚       â””â”€â”€ phase-1-progress.md   # âœ… Complete documentation
â”œâ”€â”€ src/                       # âœ… Phase 1 Foundation Complete
â”‚   â”œâ”€â”€ simple_mcp_server.py      # âœ… JSON-RPC 2.0 MCP Server
â”‚   â”œâ”€â”€ mqtt_connection_manager.py # âœ… Session management + encryption
â”‚   â””â”€â”€ mqtt_tools.py              # âœ… 3 tools + Phase 2-4 placeholders
â”œâ”€â”€ tests/                     # âœ… Complete test framework
â”‚   â””â”€â”€ test_phase1_integration.py # âœ… 13/13 tests passing
â”œâ”€â”€ requirements.txt           # âœ… Production dependencies
â”œâ”€â”€ requirements-dev.txt       # âœ… Development dependencies
â”œâ”€â”€ Dockerfile                 # âœ… Multi-stage development + production
â”œâ”€â”€ docker-compose.dev.yml     # âœ… Development environment
â”œâ”€â”€ pytest.ini               # âœ… Testing configuration
â””â”€â”€ .cursorrules              # âœ… Updated with Phase 1 complete status
```

## Next Steps ğŸš€

### Immediate Actions (Phase 2 Start)
1. **Start Phase 2 Implementation** mit real MQTT integration
2. **Create phase-2-progress.md** fÃ¼r tracking
3. **Implement aiomqtt integration** replacing mock connections
4. **Implement list_topics tool** fÃ¼r topic discovery
5. **Implement subscribe_and_collect tool** fÃ¼r message collection
6. **Implement publish_message tool** fÃ¼r message publishing

### Success Criteria for Phase 2 Completion
- **Technical**: Real MQTT broker integration working, 6 total tools functional
- **Integration**: Topic discovery and message collection working
- **Quality**: Comprehensive testing with real MQTT broker
- **Performance**: Time-bounded operations meeting targets

### Success Criteria for Project Completion (Future)
- **Technical**: All 10 MCP tools functional, performance targets met
- **Integration**: Umbrel deployment working, SSH access functional
- **Quality**: Comprehensive testing, complete documentation
- **User Experience**: AI Assistant can perform IoT analysis efficiently

## ğŸ¯ Phase 2 Ready Status Summary

**Phase 1 MCP Foundation wurde erfolgreich abgeschlossen** in nur 1 Tag (geplant waren 7 Tage). Alle Quality Gates sind erfÃ¼llt, alle Tests bestehen, und die Architektur ist ready fÃ¼r Phase 2.

**Phase 2 MQTT Core Tools** kann sofort beginnen mit:
- âœ… Solide Foundation established
- âœ… Docker development environment proven  
- âœ… Comprehensive testing framework ready
- âœ… All dependencies und risks managed
- ğŸš€ Real MQTT integration als nÃ¤chster logical step

**NÃ¤chste Action**: Start Phase 2 implementation mit real aiomqtt integration! 