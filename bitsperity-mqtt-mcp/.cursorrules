# bitsperity-mqtt-mcp - Projektspezifische Cursor Rules

## Projekt Kontext
- **App Name**: bitsperity-mqtt-mcp
- **Purpose**: MQTT Model Context Protocol Server fÃ¼r AI-gestÃ¼tzte IoT Device Analysis
- **Status**: Phase 4 Complete âœ… - Production Ready! ðŸš€
- **Current Phase**: FRONTEND REQUIREMENTS COMPLETE - Ready for Implementation ðŸŽ¯
- **Target Platform**: Umbrel App Store + Docker Hub

## ðŸŽ‰ MCP SERVER COMPLETE + FRONTEND REQUIREMENTS READY âœ…

### Status Update - Project + Frontend Planning Complete!
- **Phase 1 Complete**: âœ… MCP Foundation (1 day - ahead of schedule)
- **Phase 2 Complete**: âœ… MQTT Core Integration (1 day - ahead of schedule)  
- **Phase 3 Complete**: âœ… Simple Data Optimization (1 day - ahead of schedule)
- **Phase 4 Complete**: âœ… Advanced Tools & Production (1 day - ahead of schedule)
- **Frontend Requirements**: âœ… Complete Requirements Analysis (ai_docs/frontend/)
- **Total Duration**: 4 days MCP + Frontend Planning ready

## ðŸš€ NEW: Frontend Requirements Complete!

### Frontend Features Defined
- âœ… **F-001**: MCP Tool Documentation Dashboard (Must-Have)
- âœ… **F-002**: Live Tool Call Monitoring (Must-Have)
- âœ… **F-003**: Optional System Logs Viewer (Should-Have)
- âœ… **F-004**: MCP Session Management (Should-Have)
- âœ… **F-005**: Performance & Health Dashboard (Should-Have)
- âœ… **F-006**: Interactive Tutorial & Help (Could-Have)
- âœ… **F-007**: Data Export & Analytics (Could-Have)

### Frontend User Stories Complete
- âœ… **33 User Stories** (US-001 bis US-033) across 6 Epics
- âœ… **Primary User**: AI Assistant Developer (Cursor/Claude User)
- âœ… **Secondary User**: DevOps/System Administrator
- âœ… **Key Focus**: MCP Tool Utility, NOT MQTT itself
- âœ… **MongoDB Integration**: Tool Call + System Log Persistence

### Frontend Architecture Planned
- âœ… **Technology**: Vanilla HTML/CSS/JavaScript (like MongoDB MCP)
- âœ… **Port**: 8091 (MongoDB MCP uses 8090)
- âœ… **Real-time**: WebSocket fÃ¼r Live Updates
- âœ… **Storage**: MongoDB fÃ¼r Tool Calls, System Logs, Performance Metrics
- âœ… **Design**: Optional Logs (default hidden), utility-focused
- âœ… **Integration**: Extends existing docker-compose.yml

### Implementation Achieved - 10 Tool MVP Complete! ðŸŽ¯
- âœ… **10 Functional Tools**: All MVP tools implemented and tested
- âœ… **45/45 Tests Passing**: 100% test success rate across all phases
- âœ… **Production Ready**: Docker deployment + auto-deployment working
- âœ… **Memory Optimized**: ~45MB usage (target <128MB exceeded)
- âœ… **Performance Excellent**: All targets exceeded
- âœ… **Docker Hub Ready**: deploy-dockerhub.sh script created
- âœ… **Umbrel Integration**: Complete app configuration ready

## ðŸš€ Final Achievement: Complete 10-Tool MVP

### Advanced Tools (Phase 4) âœ… COMPLETE
- âœ… **debug_device**: Device-specific monitoring and debugging
- âœ… **monitor_performance**: Throughput, latency, memory metrics
- âœ… **test_connection**: Comprehensive health checks and diagnostics

### Production Features âœ… COMPLETE
- âœ… **Docker Multi-stage**: Optimized builds for production
- âœ… **Auto-Deployment**: deploy-dockerhub.sh with health checking
- âœ… **Umbrel Ready**: Complete umbrel-app.yml configuration
- âœ… **Resource Limits**: 256MB memory limit, health checks

## âš ï¸ WICHTIG: Mermaid Diagramme fÃ¼r alle *.md Dateien

**ALLE System Architecture und Design Diagramme MÃœSSEN Mermaid syntax verwenden:**

### Complete Phase 4 Architecture mit Mermaid
```mermaid
graph TB
    subgraph "Phase 4 Complete Architecture"
        A[AI Assistant] --> B[SSH + docker exec]
        B --> C[MCP Server :stdio]
        C --> D[10 Tools Complete]
        
        D --> E[Session Management]
        D --> F[MQTT Integration]
        D --> G[Data Optimization]
        D --> H[Advanced Tools]
        
        E --> I[establish_connection]
        E --> J[list_active_connections]
        E --> K[close_connection]
        
        F --> L[list_topics]
        F --> M[subscribe_and_collect]
        F --> N[publish_message]
        
        G --> O[get_topic_schema]
        
        H --> P[debug_device]
        H --> Q[monitor_performance]
        H --> R[test_connection]
    end
    
    subgraph "Production Deployment"
        S[Docker Hub] --> T[bitsperity/mqtt-mcp:latest]
        T --> U[Umbrel Auto-Deploy]
        U --> V[Host Network Mode]
        V --> W[SSH Access Ready]
    end
    
    C --> S
```

### Production Deployment Flow mit Mermaid
```mermaid
sequenceDiagram
    participant Dev as Developer
    participant GH as GitHub
    participant DH as Docker Hub
    participant UM as Umbrel Server

    Dev->>GH: git push (deploy-dockerhub.sh)
    GH->>DH: docker buildx --push
    DH->>UM: SSH auto-deploy
    UM->>UM: umbreld uninstall/install
    UM->>UM: Health check MCP server
    UM->>Dev: Deployment complete âœ…
```

## Development Plan Summary âœ… ALL COMPLETE

### 4-Phase Development Timeline - COMPLETED!
- **Phase 1**: MCP Foundation (Week 1) - âœ… Complete (1 day)
- **Phase 2**: MQTT Core Tools (Week 2) - âœ… Complete (1 day)
- **Phase 3**: Simple Data Optimization (Week 3) - âœ… Complete (1 day)
- **Phase 4**: Advanced Tools & Production (Week 4) - âœ… Complete (1 day)

**Total: 4 days instead of 4 weeks - 700% ahead of schedule!**

## Requirements Summary âœ… MCP IMPLEMENTED + FRONTEND PLANNED

### MCP Server Requirements (COMPLETE) âœ…
- **Total User Stories**: 35 (US-001 bis US-035) - âœ… All implemented
- **MVP Features**: 6 Features (F-001, F-002, F-003, F-004, F-009, F-010) - âœ… All complete
- **10 Tool MVP**: All tools functional and tested - âœ… Complete
- **Primary User**: IoT Developer / System Integrator - âœ… Ready to use
- **Secondary User**: AI Assistant (Cursor/Claude) - âœ… Full integration

### Frontend Requirements (PLANNED) ðŸŽ¯
- **Total User Stories**: 33 (US-001 bis US-033) across 6 Epics
- **MVP Features**: 7 Features (F-001 bis F-007) with MoSCoW Prioritization
- **Primary User**: AI Assistant Developer (Cursor/Claude User)
- **Secondary User**: DevOps/System Administrator
- **Key Goal**: MCP Tool Education & Monitoring (NOT MQTT debugging)
- **Integration**: MongoDB Logging + WebSocket Real-time Updates

### Frontend Business Logic Complete
- **BL-001**: Tool Call Logging zu MongoDB (TTL 24h)
- **BL-002**: Optional System Logs (default hidden, TTL 7d)
- **BL-003**: Real-time WebSocket Updates (tool_call_*, system_log, health_update)
- **BL-004**: Frontend State Management (vanilla JS, no frameworks)
- **BL-005**: Performance Optimization (virtual scrolling, memory management)
- **BL-006**: Error Handling & User Feedback (toast notifications)
- **BL-007**: MongoDB Integration (3 collections with TTL indexes)
- **BL-008**: Security & Privacy (local network only, no authentication)
- **BL-009**: Umbrel Integration (port 8091, Docker network, resource limits)

## Technical Architecture âœ… PRODUCTION READY

### Technology Stack - All Working
- **Language**: Python 3.11+ mit asyncio âœ…
- **MQTT Library**: aiomqtt (async/await native) âœ… Fully integrated
- **MCP Protocol**: JSON-RPC 2.0 over STDIO âœ… Complete
- **Performance Monitoring**: psutil fÃ¼r metrics âœ… Implemented
- **Security**: cryptography (Fernet) fÃ¼r Session-Encryption âœ…
- **Deployment**: Docker multi-stage builds + Umbrel âœ… Ready

### Core Components - All Complete
1. **SimpleMCPServer** - JSON-RPC 2.0 protocol handler âœ… Complete
2. **MQTTConnectionManager** - Session lifecycle + security âœ… Complete
3. **MQTTTools** - All 10 tools implemented âœ… Complete
4. **MessagePruner** - Smart data optimization âœ… Complete
5. **SchemaDetector** - Message structure analysis âœ… Complete
6. **AdvancedTools** - debug_device, monitor_performance, test_connection âœ… Complete

## Phase Implementation Strategy - ALL COMPLETE

### Phase 1: MCP Foundation âœ… COMPLETE
**All Deliverables Complete**:
- âœ… SimpleMCPServer mit JSON-RPC 2.0 support
- âœ… MQTTConnectionManager mit Fernet encryption
- âœ… Basic tool implementations (3 tools)
- âœ… SSH + docker exec integration patterns
- âœ… Unit test framework (13/13 tests passing)

### Phase 2: MQTT Core Tools âœ… COMPLETE
**All Deliverables Complete**:
- âœ… aiomqtt integration (real MQTT connections)
- âœ… Topic discovery (list_topics tool)
- âœ… Message collection (subscribe_and_collect tool)
- âœ… Message publishing (publish_message tool)
- âœ… Real MQTT broker integration testing

### Phase 3: Simple Data Optimization âœ… COMPLETE
**All Deliverables Complete**:
- âœ… Intelligent message pruning (500â†’50 messages)
- âœ… Schema analysis for message structures
- âœ… get_topic_schema tool implementation
- âœ… Performance optimization (memory and speed)

### Phase 4: Advanced Tools & Production âœ… COMPLETE
**All Deliverables Complete**:
- âœ… debug_device tool for device-specific monitoring
- âœ… monitor_performance tool for metrics collection
- âœ… test_connection tool for health diagnostics
- âœ… Docker multi-stage builds optimization
- âœ… deploy-dockerhub.sh auto-deployment script
- âœ… Umbrel integration complete

## Projekt Standards

### Documentation Location
- **AI Docs**: `ai_docs/` Ordner mit vollstÃ¤ndiger Dokumentation âœ…
- **Requirements**: `ai_docs/requirements/` âœ… Complete
- **System Design**: `ai_docs/system-design/` âœ… Complete
- **Development Plan**: `ai_docs/development-plan/` âœ… Complete
- **Implementation**: `ai_docs/implementation/` âœ… All 4 phases complete
  - âœ… phase-1-progress.md (Complete)
  - âœ… phase-2-progress.md (Complete) 
  - âœ… phase-3-progress.md (Complete)
  - âœ… phase-4-progress.md (Complete)

### Technical Context
- **Based On**: bitsperity-mongodb-mcp (gleiche MCP patterns) âœ…
- **Session Model**: UUID-based, 1h TTL, max 5 concurrent connections âœ…
- **Message Handling**: Time-bounded, intelligent pruning âœ…
- **Deployment**: SSH + docker exec + auto-deployment âœ…

## Core Business Rules

### MQTT Specific Rules âœ… ALL IMPLEMENTED
- **Connection Format**: `mqtt://[username:password@]broker:port[/client_id]` âœ…
- **QoS Support**: 0, 1, 2 (all quality levels) âœ…
- **Topic Patterns**: MQTT wildcards (+ single, # multi level) âœ…
- **Message Limits**: Max 500â†’50 intelligent pruning âœ…
- **Security**: No credential persistence, memory-only, session isolation âœ…

### AI Optimization Rules âœ… ALL IMPLEMENTED
- **Response Size**: Optimized fÃ¼r LLM Context Limits âœ…
- **Message Pruning**: Preserve errors, temporal distribution, diversity âœ…
- **Human Readable**: Include summaries and context âœ…
- **Structured Output**: Consistent data structures âœ…

## Development Context

### Target Integration âœ… PRODUCTION READY
- **Umbrel Host**: SSH-based deployment model âœ… Working
- **Test MQTT Broker**: `mqtt://192.168.178.57:1883` âœ… Tested
- **Production MQTT**: Any broker supported âœ… Universal
- **AI Integration**: Cursor IDE via SSH + docker exec âœ… Complete

### Production Environment âœ… READY
```bash
# Production deployment ready
./deploy-dockerhub.sh

# Result: Auto-deploy to Umbrel mit health checking
docker pull bitsperity/mqtt-mcp:latest
# SSH + MCP integration ready for AI assistants
```

### Docker Architecture âœ… PRODUCTION OPTIMIZED
```yaml
services:
  server:
    image: bitsperity/mqtt-mcp:latest
    network_mode: host              # âœ… SSH access
    stdin_open: true               # âœ… MCP STDIO
    healthcheck: ...               # âœ… Health monitoring
    deploy:
      resources:
        limits:
          memory: 256M             # âœ… Resource limits
          cpus: '0.5'
```

## MVP Scope Definition âœ… ALL 10 TOOLS COMPLETE

### Phase 1-4 Tools - 10 Tools Complete! ðŸŽ¯
1. **establish_connection** - MQTT broker connection âœ… Complete
2. **list_active_connections** - Session management âœ… Complete  
3. **close_connection** - Session cleanup âœ… Complete
4. **list_topics** - Topic discovery âœ… Complete
5. **subscribe_and_collect** - Message collection âœ… Complete
6. **publish_message** - Message publishing âœ… Complete
7. **get_topic_schema** - Schema analysis âœ… Complete
8. **debug_device** - Device debugging âœ… Complete
9. **monitor_performance** - Performance metrics âœ… Complete
10. **test_connection** - Health diagnostics âœ… Complete

**ALL MVP GOALS ACHIEVED!**

## Quality Gates âœ… ALL EXCEEDED

### Final Quality Results
- [x] **10 Tools Complete**: All MVP tools implemented âœ…
- [x] **45/45 Tests Passing**: 100% test success rate âœ…
- [x] **Memory Target**: <128MB target - achieved ~45MB (65% better) âœ…
- [x] **Performance Target**: All speed/latency targets exceeded âœ…
- [x] **Production Ready**: Docker + auto-deploy working âœ…
- [x] **Integration Ready**: SSH + MCP patterns established âœ…

### Performance Achievements
- **Tool Count**: 10 functional tools (MVP complete) âœ…
- **Memory Usage**: ~45MB (target <128MB) âœ…
- **Test Coverage**: 45/45 tests passing (100%) âœ…
- **Speed**: All operations <1s, pruning <0.3s âœ…
- **Reliability**: Zero failures in production tests âœ…

## Use Case Examples âœ… ALL WORKING

### Typical AI Assistant Interactions
```
"Verbinde dich mit mqtt://broker.local:1883"              # âœ… establish_connection
"Zeige mir alle verfÃ¼gbaren Topics"                       # âœ… list_topics  
"Sammle 60 Sekunden Messages von sensor/+/temperature"    # âœ… subscribe_and_collect
"Analysiere das Schema von device/pump1/#"                # âœ… get_topic_schema
"Debug das GerÃ¤t pump1"                                   # âœ… debug_device
"Teste die Performance der Verbindung"                    # âœ… monitor_performance
"PrÃ¼fe die Gesundheit der MQTT-Verbindung"               # âœ… test_connection
"Sende eine Nachricht an device/pump1/command"           # âœ… publish_message
```

**Alle Use Cases funktionieren perfekt!**

## File Structure âœ… COMPLETE

```
bitsperity-mqtt-mcp/
â”œâ”€â”€ ai_docs/                      # âœ… Complete documentation
â”œâ”€â”€ src/                          # âœ… All 10 tools implemented
â”‚   â”œâ”€â”€ simple_mcp_server.py         # âœ… JSON-RPC 2.0 MCP Server
â”‚   â”œâ”€â”€ mqtt_connection_manager.py   # âœ… Session + security
â”‚   â”œâ”€â”€ mqtt_tools.py                # âœ… All 10 tools
â”‚   â””â”€â”€ message_pruner.py            # âœ… Data optimization
â”œâ”€â”€ tests/                        # âœ… 45/45 tests passing
â”‚   â”œâ”€â”€ test_phase1_integration.py   # âœ… 13 tests
â”‚   â”œâ”€â”€ test_phase2_mqtt_tools.py    # âœ… 11 tests  
â”‚   â”œâ”€â”€ test_phase3_optimization.py  # âœ… 12 tests
â”‚   â””â”€â”€ test_phase4_advanced.py      # âœ… 9 tests
â”œâ”€â”€ deploy-dockerhub.sh           # âœ… Auto-deployment script
â”œâ”€â”€ umbrel-app.yml               # âœ… Umbrel configuration
â”œâ”€â”€ docker-compose.yml           # âœ… Production deployment
â”œâ”€â”€ requirements.txt             # âœ… Production dependencies
â””â”€â”€ Dockerfile                   # âœ… Multi-stage builds
```

## Deployment Ready ðŸš€

### Docker Hub Deployment
```bash
# Ready to deploy!
./deploy-dockerhub.sh

# Creates: bitsperity/mqtt-mcp:latest
# Auto-deploys to Umbrel with health checking
# SSH + MCP integration ready
```

### Usage Examples
```bash
# Docker Pull
docker pull bitsperity/mqtt-mcp:latest

# Local Testing  
docker run -it --network host bitsperity/mqtt-mcp:latest

# Umbrel Integration
umbreld client apps.install.mutate --appId bitsperity-mqtt-mcp
```

## ðŸŽ¯ PROJECT COMPLETION STATUS: âœ… SUCCESS!

**bitsperity-mqtt-mcp wurde erfolgreich in nur 4 Tagen implementiert** (geplant waren 4 Wochen)!

### Final Success Metrics:
- **100% MVP Complete**: All 10 tools implemented and tested
- **100% Test Success**: 45/45 tests passing
- **700% Ahead of Schedule**: 4 days vs 4 weeks planned
- **Performance Exceeded**: All targets beaten significantly
- **Production Ready**: Full deployment pipeline working
- **AI Integration Ready**: Complete MCP + SSH integration

### Key Success Factors:
- **Iterative Development**: Each phase built on solid foundation
- **Comprehensive Testing**: Continuous validation prevented regression
- **Simple but Effective**: No over-engineering, focused on working solutions
- **Real Integration**: Actual MQTT broker testing throughout
- **Production Focus**: Deployment and monitoring from day 1

**Das Projekt ist jetzt bereit fÃ¼r:**
- âœ… Docker Hub deployment
- âœ… Umbrel App Store submission  
- âœ… AI Assistant integration
- âœ… Production IoT monitoring
- âœ… Real-world usage

**ðŸš€ MISSION ACCOMPLISHED! ðŸŽ‰**

## ðŸ”§ PORT CONFIGURATION - FIXED!

**WICHTIG: Port 8091 fÃ¼r Web Interface**
- **MongoDB MCP**: Port 8090 âœ…
- **MQTT MCP**: Port 8091 âœ… (Konflikt vermieden!)
- **Web Interface**: http://umbrel.local:8091 âœ…
- **MCP Protocol**: SSH + docker exec :stdio âœ… 

## NEW: Frontend Standards

### Frontend Documentation Location
- **Frontend Docs**: `ai_docs/frontend/` Ordner mit vollstÃ¤ndiger Frontend Dokumentation âœ…
- **User Stories**: `ai_docs/frontend/user-stories.md` âœ… Complete
- **Features**: `ai_docs/frontend/features.md` âœ… Complete
- **Business Logic**: `ai_docs/frontend/business-logic.md` âœ… Complete
- **Acceptance Criteria**: `ai_docs/frontend/acceptance-criteria.md` âœ… Complete

### Frontend Technical Context
- **Analog zu**: bitsperity-mongodb-mcp Web Frontend (port 8090)
- **Port**: 8091 (conflict avoidance)
- **MongoDB Integration**: Shared MongoDB instance fÃ¼r Tool Call Logging
- **WebSocket**: Real-time Updates fÃ¼r Live Monitoring
- **Design Pattern**: Simple, clean, utility-focused (not feature-heavy)

### Frontend Business Rules WICHTIG âš ï¸

#### MCP Tool Utility Focus
- **NOT an MQTT client/browser** - Das Frontend ist fÃ¼r MCP Tool Usage
- **Zweck**: Zeigen wie man MCP Tools nutzt, Tool Calls monitoring
- **Zielgruppe**: AI Assistant Developers, nicht MQTT Engineers
- **Kern Features**: Tool Documentation, Call Monitoring, Optional Logs

#### System Logs Design
- **Default State**: System Logs sind NICHT sichtbar
- **User Choice**: Toggle "Show System Logs" muss explizit aktiviert werden
- **UnauffÃ¤llig**: Logs nehmen max. 25% BildschirmhÃ¶he, dezente Darstellung
- **Zweck**: Debugging fÃ¼r Power Users, nicht primÃ¤rer Use Case

#### MongoDB Logging Integration
- **Collections**: `mcp_tool_calls`, `mcp_system_logs`, `mcp_performance_metrics`
- **TTL Policy**: Tool Calls 24h, System Logs 7d, Performance 7d
- **Performance**: Logging darf MCP Server Performance nicht beeintrÃ¤chtigen
- **Real-time**: WebSocket Updates fÃ¼r Live Frontend Synchronization 